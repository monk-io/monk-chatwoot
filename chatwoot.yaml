namespace: /chatwoot

common:
  version: latest
  metadata:
    defines: metadata
    name: Chatwoot
    description: Open-source live chat software, an alternative to Intercom, Zendesk, Salesforce Service Cloud etc. ðŸ”¥ðŸ’¬
    tags: self hosted, messaging, communication
    website: www.chatwoot.com
    source: https://github.com/chatwoot/chatwoot
    publisher: "monk.io"
    icon: https://storage.googleapis.com/template_logos/chatwoot-image.png

  containers:
    defines: containers
    rails:
      image: chatwoot/chatwoot:latest
      environment:
        - NODE_ENV=production
        - RAILS_ENV=production
        - DEFAULT_LOCALE=en
        - FRONTEND_URL=http://0.0.0.0:3000
        - <- `SECRET_KEY_BASE=${secret-key-base}`
        - <- `REDIS_URL=redis://${redis-host}:6379`
        - <- `POSTGRES_HOST=${db-host}`
        - <- `POSTGRES_USERNAME=${db-user}`
        - <- `POSTGRES_PASSWORD=${db-password}`
        - <- `SMTP_ADDRESS=${smtp-host}`
        - <- `SMTP_PORT=${smtp-port}`
        - <- `SMTP_USERNAME=${smtp-user}`
        - <- `SMTP_PASSWORD=${smtp-password}`
  variables:
    defines: variables
    secret-key-base: 3beeee45bc938475ecba45075c53aae0f94299a83f824b25bbaf7965b4b0c60ff2b0c66c9047a026578deb5ecadabaa602891be2be66ed123a7b26876d4daddf
    db-user: postgres
    db-password: password
    db-port: 5432
    smtp-user: ""
    smtp-password: ""
    smtp-port: 1025

    db-host: <- get-hostname("chatwoot/postgres", "postgres")
    redis-host: <- get-hostname("chatwoot/redis", "redis")
    smtp-host: <- get-hostname("chatwoot/mailhog", "mailhog")

postgres:
  defines: runnable
  inherits: /postgres/12
  variables:
    db-name: chatwoot_production
    db-user: postgres
    db-password: password
    db-port: 5432

redis:
  defines: runnable
  inherits: /redis/alpine

chatwoot:
  defines: runnable
  inherits: ./common
  containers:
    rails:
      entrypoint: <- `/bin/sh /init.sh`
      ports:
        - 0.0.0.0:3000:3000
  files:
    defines: files
    init:
      path: /init.sh
      container: rails
      contents: | 
        bundle exec rails db:chatwoot_prepare RAILS_ENV=production 
        bundle exec rails s -p 3000 -b 0.0.0.0
  depends:
    defines: depends
    wait-for:
      runnables:
        - /chatwoot/postgres
        - /chatwoot/redis
      timeout: 60

sidekiq:
  defines: runnable
  inherits: ./common
  containers:
    rails:
      bash: <- `bundle exec sidekiq -C /config/sidekiq.yml`
  files:
    defines: files
    sidekiq-conf:
      path: /config/sidekiq.yml
      container: rails
      contents: |
        :verbose: false
        :concurrency: 5
        :timeout: 25
        
        :queues:
          - [low, 1]
          - [scheduled_jobs, 1]
          - [webhooks, 1]
          - [bots, 1]
          - [active_storage_analysis, 1]
          - [action_mailbox_incineration, 1]
          - [integrations, 2]
          - [default, 2]
          - [mailers, 2]
          - [medium, 3]
          - [events, 3]
          - [action_mailbox_routing, 3]
          - [high, 5]
          - [critical, 10]
          
        production:
          :concurrency: 10
        staging:
          :concurrency: 5
  depends:
    defines: depends
    wait-for:
      runnables:
        - /chatwoot/postgres
        - /chatwoot/redis
      timeout: 60

mailhog:
  defines: runnable
  inherits: /mailhog/latest

stack:
  defines: process-group
  version: latest
  metadata:
    defines: metadata
    name: Chatwoot
    description: Open-source live chat software, an alternative to Intercom, Zendesk, Salesforce Service Cloud etc. ðŸ”¥ðŸ’¬
    tags: self hosted, messaging, communication
    website: www.chatwoot.com
    source: https://github.com/chatwoot/chatwoot
    publisher: "monk.io"
    icon: https://storage.googleapis.com/template_logos/chatwoot-image.png
    email: maciej@monk.io
  runnable-list:
    - /chatwoot/redis
    - /chatwoot/postgres
    - /chatwoot/sidekiq
    - /chatwoot/chatwoot
    - /chatwoot/mailhog
