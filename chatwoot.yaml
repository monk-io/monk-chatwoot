namespace: /chatwoot

common:
  version: latest
  metadata:
    defines: metadata
    name: Chatwoot
    description: Open-source live chat software, an alternative to Intercom, Zendesk, Salesforce Service Cloud etc. ðŸ”¥ðŸ’¬
    tags: self hosted, messaging, communication
    website: www.chatwoot.com
    source: https://github.com/chatwoot/chatwoot
    publisher: "monk.io"
    icon: https://storage.googleapis.com/template_logos/chatwoot-image.png
    email: hello@chatwoot.com
  containers:
    defines: containers
    rails:
      image: chatwoot/chatwoot:latest
      environment:
        - NODE_ENV=production
        - RAILS_ENV=production
        - DEFAULT_LOCALE=en
        - <- `SECRET_KEY_BASE=${secret-key-base}`
        - <- `REDIS_URL=redis://${redis-host}:6379`
        - <- `POSTGRES_HOST=${db-host}`
        - <- `POSTGRES_USERNAME=${postgres-db-user}`
        - <- `POSTGRES_PASSWORD=${postgres-db-password}`
        - <- `MAILER_SENDER_EMAIL=${mailer-sender-email}`
        - <- `SMTP_ADDRESS=${smtp-address}`
        - <- `SMTP_PORT=${smtp-port}`
        - <- `SMTP_USERNAME=${smtp-username}`
        - <- `SMTP_PASSWORD=${smtp-password}`
        - <- `SMTP_AUTHENTICATION=${smtp-authentication}`
        - <- `SMTP_ENABLE_STARTTLS_AUTO=${smtp-enable-startttls-auto}`
        - <- `SMTP_DOMAIN=${smtp-domain}`
        - <- `REDIS_PASSWORD=${redis-password}`
        - <- `FRONTEND_URL=${frontend-url}`
        - <- `ENABLE_ACCOUNT_SIGNUP=${enable-account-signup}`
        - <- `SLACK_CLIENT_ID=${slack-client-id}`
        - <- `SLACK_CLIENT_SECRET=${slack-client-secret}`
  variables:
    defines: variables
    db-host: <- get-hostname("chatwoot/postgres", "postgres") ".monk" concat
    redis-host: <- get-hostname("chatwoot/redis", "redis") ".monk" concat
    chatwoot-url: <- get-hostname("chatwoot/chatwoot", "rails") ".monk" concat

nginx:
  defines: runnable
  inherits: /nginx/reverse-proxy-ssl-certbot
  variables:
    defines: variables
    chatwoot-url: <- get-hostname("chatwoot/chatwoot", "rails") ".monk" concat
    ssl: <- $use-ssl
    server-name: <- $domain
    email: <- $domain-email
    proxy-pass-protocol: <- $proxy-protocol
  files:
    defines: files
    server-def:
      contents: |
        server {
          underscores_in_headers on;
          listen 80;
          server_name {{ v "server-name" }} www.{{ v "server-name" }};
          {{ if v "ssl" }}
          location /.well-known/acme-challenge/ {
            root /var/www/certbot;
          }
          {{ end }}
          
          proxy_pass_request_headers on;
          proxy_http_version 1.1;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Server $host;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header Host $host;
          
          location / {
            {{ if v "ssl" }}
            return 301 https://{{ v "server-name" }}$request_uri;
            {{ else }}
            proxy_pass {{ v "proxy-pass-protocol" }}://{{ v "chatwoot-url" }}:{{ v "chatwoot-port" }};
            {{ end }}
          }
        }
        {{ if v "ssl" }}
        server {
          underscores_in_headers on;
          listen 443 ssl;
          server_name {{ v "server-name" }} www.{{ v "server-name" }};
          ssl_certificate /usr/share/nginx/certificates/fullchain.pem;
          ssl_certificate_key /usr/share/nginx/certificates/privkey.pem;
          include /etc/ssl-options/options-nginx-ssl.conf;
          ssl_dhparam /etc/ssl-options/ssl-dhparams.pem;

          proxy_pass_request_headers on;
          proxy_http_version 1.1;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Server $host;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header Host $host;

          location /cable {
          proxy_pass {{ v "proxy-pass-protocol" }}://{{ v "chatwoot-url" }}:{{ v "chatwoot-port" }}/cable;
          proxy_http_version 1.1;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Host $http_host;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "Upgrade";
          }

          location / {
            proxy_pass {{ v "proxy-pass-protocol" }}://{{ v "chatwoot-url" }}:{{ v "chatwoot-port" }};
          }
        } 
        {{ end }}
    
postgres:
  defines: runnable
  inherits: /postgres/12
  containers:
    defines: containers
    postgres:
      ports:
        - 5432
  variables:
    db-user: <- $postgres-db-user
    db-password: <- $postgres-db-password
    db-port: <- $postgres-db-port

redis:
  defines: runnable
  inherits: /redis/alpine
  containers:
    defines: containers
    redis:
      entrypoint: <- `redis-server --requirepass ${redis-password}`
      ports:
        - 6379
  checks:
    defines: checks
    readyness:
      code: exec("redis", "/bin/sh", "-c", `redis-cli -a ${redis-password} ping`) "PONG" contains?
      period: 5
      initialDelay: 10
  variables:
    defines: variables
    use-password:
      value: true

chatwoot:
  defines: runnable
  inherits: ./common
  containers:
    rails:
      entrypoint: <- `/bin/sh /init.sh`
      ports:
        - <- `${chatwoot-port}`
  files:
    defines: files
    init:
      path: /init.sh
      container: rails
      contents: | 
        bundle exec rails db:chatwoot_prepare
        bundle exec rails s -p {{ v "chatwoot-port" }} -b 0.0.0.0
    token-script:
      container: rails
      path: /tokenscript.sh
      mode: 0770
      contents: |
        #!/usr/bin/env sh
        TOKENFILE=/webtoken
        USER=$1
        PASSWORD=$2
        APP_NAME=$3
        if test -f "$TOKENFILE"; then
          TOKEN=$(cat $TOKENFILE)
        else
          cd app
          TOKEN=$(echo "PlatformApp.create(name: '$APP_NAME').access_token.token;
          SuperAdmin.create!(email: '$USER', password: '$PASSWORD')
          account = Account.create!(name: '$APP_NAME')
          user = User.new(email: '$USER',
                          password: '$PASSWORD',
                          password_confirmation: '$PASSWORD',
                          name: '$APP_NAME')
          user.confirm(false)
          user.save!

          AccountUser.create!(account_id: account.id,
                              user_id: user.id,
                              role: AccountUser.roles['administrator']);

          c = Channel::WebWidget.create!(account: account, website_url: 'test.com')

          Inbox.create!(channel: c, account: account, name: '$APP_NAME')

          File.open('/webtoken', 'w'){|file| file.write(c.website_token);};
          ::Redis::Alfred.delete(::Redis::Alfred::CHATWOOT_INSTALLATION_ONBOARDING)
          exit" | bundle exec rails c)
          cd ..
        fi
        cat $TOKENFILE
  actions:
    defines: actions
    get-token:
      arguments:
        user:
          type: string
          description: email for default user and superadmin
          default: user@chatwoot.io
        password:
          type: string
          description: password for default user and superadmin
          default: Pass1234!
        app-name:
          type: string
          description: app name which will be displayed in chatwoot
          default: demo app
      code: exec("rails", "/bin/sh", "/tokenscript.sh", $args["user"], $args["password"], $args["app-name"])

dev-chatwoot:
  defines: runnable
  inherits: ./chatwoot
  containers:
    rails:
      ports:
        - <- `${chatwoot-port}:${chatwoot-port}`

sidekiq:
  defines: runnable
  inherits: ./common
  depends:
    defines: depends
    wait-for:
        runnables:
            - chatwoot/redis
        timeout: 60
  containers:
    rails:
      bash: <- `bundle exec sidekiq -C /config/sidekiq.yml`
  files:
    defines: files
    sidekiq-conf:
      path: /config/sidekiq.yml
      container: rails
      contents: |
        :verbose: false
        :concurrency: 5
        :timeout: 25
        
        :queues:
          - [low, 1]
          - [scheduled_jobs, 1]
          - [webhooks, 1]
          - [bots, 1]
          - [active_storage_analysis, 1]
          - [action_mailbox_incineration, 1]
          - [integrations, 2]
          - [default, 2]
          - [mailers, 2]
          - [medium, 3]
          - [events, 3]
          - [action_mailbox_routing, 3]
          - [high, 5]
          - [critical, 10]
          
        production:
          :concurrency: 10
        staging:
          :concurrency: 5

group-variables:
    defines: variables
    proxy-protocol: http
    chatwoot-port: 3000
    domain: chat.yoursite.io
    domain-email: chat@yoursite.io
    use-ssl: true
    rails-env:
      env: RAILS_ENV
      value: production
    secret-key-base:
      env: SECRET_KEY_BASE
      value: 3bsefe45bc938475ecba45075c53cdf0f94299a23f821b05beaf7955b4b0c60ff2b0c66c9047a026578deb5ecadabgs342891be2be68ed123a7b26876d4daddf
    postgres-db-user:
      env: POSTGRES_USERNAME
      value: postgres
    postgres-db-password:
      env: POSTGRES_PASSWORD
      value: "CHANGE_ME"
    postgres-db-port: 5432
    smtp-username:
      env: SMTP_USERNAME
      value: "chat@yoursite.io"
    smtp-password:
      env: SMTP_PASSWORD
      value: "CHANGE_ME"
    smtp-port:
      env: SMTP_PORT
      value: 1025
    smtp-address:
      env: SMTP_ADDRESS
      value: "SMTP_HOST"
    smtp-authentication:
      env: SMTP_AUTHENTICATION
      value: PLAIN
    smtp-enable-startttls-auto:
      env: SMTP_ENABLE_STARTTLS_AUTO
      value: true
    smtp-domain:
      env: SMTP_DOMAIN
      value: "yoursite.io"
    redis-password:
      env: REDIS_PASSWORD
      value: "CHANGE_ME"
    mailer-sender-email:
      env: MAILER_SENDER_EMAIL
      value: "chat@yoursite.io"
    frontend-url:
      env: FRONTEND_URL
      value: "https://chat.yoursite.io"
    enable-account-signup:
      value: false
    slack-client-id:
      value: ""
    slack-client-secret:
      value: ""

stack:
  defines: process-group
  version: latest
  runnable-list:
    - /chatwoot/redis
    - /chatwoot/postgres
    - /chatwoot/sidekiq
    - /chatwoot/chatwoot
    - /chatwoot/nginx
  variables:
    defines: variables
    inherits: ./group-variables

dev-stack:
  defines: process-group
  runnable-list:
    - /chatwoot/redis
    - /chatwoot/postgres
    - /chatwoot/sidekiq
    - /chatwoot/dev-chatwoot
  variables:
    defines: variables
    inherits: ./group-variables
