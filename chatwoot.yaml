namespace: /chatwoot

nginx:
  defines: runnable
  inherits: /nginx/reverse-proxy-ssl-certbot
  variables:
    defines: variables
    chatwoot-url: <- get-hostname("chatwoot/chatwoot", "rails")
  files:
    defines: files
    server-def:
      contents: |
        server {
          underscores_in_headers on;
          listen 80;
          server_name {{ v "server-name" }} www.{{ v "server-name" }};
          {{ if v "ssl" }}
          location /.well-known/acme-challenge/ {
            root /var/www/certbot;
          }
          {{ end }}
          
          proxy_pass_request_headers on;
          proxy_http_version 1.1;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Server $host;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header Host $host;
          
          location / {
            {{ if v "ssl" }}
            return 301 https://{{ v "server-name" }}$request_uri;
            {{ else }}
            proxy_pass {{ v "proxy-pass-protocol" }}://{{ v "chatwoot-url" }}:{{ v "chatwoot-port" }};
            {{ end }}
          }
        }
        {{ if v "ssl" }}
        server {
          underscores_in_headers on;
          listen 443 ssl;
          server_name {{ v "server-name" }} www.{{ v "server-name" }};
          ssl_certificate /usr/share/nginx/certificates/fullchain.pem;
          ssl_certificate_key /usr/share/nginx/certificates/privkey.pem;
          include /etc/ssl-options/options-nginx-ssl.conf;
          ssl_dhparam /etc/ssl-options/ssl-dhparams.pem;

          proxy_pass_request_headers on;
          proxy_http_version 1.1;
          proxy_set_header X-Forwarded-Host $host;
          proxy_set_header X-Forwarded-Server $host;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header Host $host;

          location /cable {
          proxy_pass {{ v "proxy-pass-protocol" }}://{{ v "chatwoot-url" }}:{{ v "chatwoot-port" }}/cable;
          proxy_http_version 1.1;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Host $http_host;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "Upgrade";
          }
          
          location / {
            proxy_pass {{ v "proxy-pass-protocol" }}://{{ v "chatwoot-url" }}:{{ v "chatwoot-port" }};
          }
        } 
        {{ end }}


common:
  version: latest
  metadata:
    defines: metadata
    name: Chatwoot
    description: Open-source live chat software, an alternative to Intercom, Zendesk, Salesforce Service Cloud etc. ðŸ”¥ðŸ’¬
    tags: self hosted, messaging, communication
    website: www.chatwoot.com
    source: https://github.com/chatwoot/chatwoot
    publisher: "monk.io"
    icon: https://storage.googleapis.com/template_logos/chatwoot-image.png
    email: maciej@monk.io
  containers:
    defines: containers
    rails:
      image: chatwoot/chatwoot:latest
      environment:
        - NODE_ENV=production
        - DEFAULT_LOCALE=en
        - <- `REDIS_URL=redis://${redis-host}:6379`
        - <- `SECRET_KEY_BASE=${secret-key-base}`
        - <- `REDIS_URL=redis://${redis-host}:6379`
        - <- `POSTGRES_HOST=${db-host}`
        - <- `POSTGRES_USERNAME=${db-user}`
        - <- `POSTGRES_PASSWORD=${db-password}`
        - <- `SMTP_ADDRESS=${smtp-address}`
        - <- `SMTP_PORT=${smtp-port}`
        - <- `SMTP_USERNAME=${smtp-username}`
        - <- `SMTP_PASSWORD=${smtp-password}`
        - <- `REDIS_PASSWORD=${redis-password}`
  variables:
    defines: variables
    db-host: <- get-hostname("chatwoot/postgres", "postgres")
    redis-host: <- get-hostname("chatwoot/redis", "redis")
    chatwoot-url: <- get-hostname("chatwoot/chatwoot", "rails")

postgres:
  defines: runnable
  inherits: /postgres/12
  containers:
    defines: containers
    postgres:
      ports:
        - 5432

redis:
  defines: runnable
  inherits: /redis/alpine
  containers:
    defines: containers
    redis:
      entrypoint: <- `redis-server --requirepass ${redis-password}`
      ports:
        - 6379

chatwoot:
  defines: runnable
  inherits: ./common
  containers:
    rails:
      entrypoint: <- `/bin/sh /init.sh`
      ports:
        - "0.0.0.0:3000:3000"
  depends:
    defines: depends
    wait-for:
      runnables:
        - chatwoot/postgres
      timeout: 60
  files:
    defines: files
    init:
      path: /init.sh
      container: rails
      contents: | 
        bundle exec rails db:chatwoot_prepare RAILS_ENV=production 
        bundle exec rails s -p 3000 -b 0.0.0.0

sidekiq:
  defines: runnable
  inherits: ./common
  containers:
    rails:
      bash: <- `bundle exec sidekiq -C /config/sidekiq.yml`
  files:
    defines: files
    sidekiq-conf:
      path: /config/sidekiq.yml
      container: rails
      contents: |
        :verbose: false
        :concurrency: 5
        :timeout: 25
        
        :queues:
          - [low, 1]
          - [scheduled_jobs, 1]
          - [webhooks, 1]
          - [bots, 1]
          - [active_storage_analysis, 1]
          - [action_mailbox_incineration, 1]
          - [integrations, 2]
          - [default, 2]
          - [mailers, 2]
          - [medium, 3]
          - [events, 3]
          - [action_mailbox_routing, 3]
          - [high, 5]
          - [critical, 10]
          
        production:
          :concurrency: 10
        staging:
          :concurrency: 5

stack:
  defines: process-group
  version: latest
  metadata:
    defines: metadata
    name: Chatwoot
    description: Open-source live chat software, an alternative to Intercom, Zendesk, Salesforce Service Cloud etc. ðŸ”¥ðŸ’¬
    tags: self hosted, messaging, communication
    website: www.chatwoot.com
    source: https://github.com/chatwoot/chatwoot
    publisher: "monk.io"
    icon: https://storage.googleapis.com/template_logos/chatwoot-image.png
    email: maciej@monk.io
  runnable-list:
    - /chatwoot/redis
    - /chatwoot/postgres
    - /chatwoot/sidekiq
    - /chatwoot/chatwoot
  #  - /chatwoot/nginx
  variables:
    defines: variables
    proxy-pass-protocol: http
    chatwoot-port: 3000
    server-name: chat.yoursite.io
    email: chat@yoursite.io
    ssl: true
    frontend-url:
      env: FRONTEND_URL
      value: http://0.0.0.0:3000
    rails-env:
      env: RAILS_ENV
      value: production
    secret-key-base:
      env: SECRET_KEY_BASE
      value: 3bsefe45bc938475ecba45075c53cdf0f94299a23f821b05beaf7955b4b0c60ff2b0c66c9047a026578deb5ecadabgs342891be2be68ed123a7b26876d4daddf
    db-user:
      env: POSTGRES_USERNAME
      value: postgres
    db-password:
      env: POSTGRES_PASSWORD
      value: "CHANGE_ME"
    db-port: 5432
    smtp-username:
      env: SMTP_USERNAME
      value: "chat@yoursite.io"
    smtp-password:
      env: SMTP_PASSWORD
      value: "CHANGE_ME"
    smtp-port:
      env: SMTP_PORT
      value: 1025
    smtp-address:
      env: SMTP_ADDRESS
      value: "SMTP_HOST"
    redis-password:
      env: REDIS_PASSWORD
      value: "CHANGE_ME"
    sidekiq_auth_username:
      env: SIDEKIQ_AUTH_USERNAME
      value: "chat@yoursite.io"
    sidekiq_auth_password:
      env: SIDEKIQ_AUTH_PASSWORD
      value: "CHANGE_ME"
